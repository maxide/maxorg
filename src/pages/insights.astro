---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import DonationBanner from '../components/DonationBanner.astro';
---

<Layout title="Insights & Community Stories - Maxsys International" description="Read the latest insights, success stories, and updates from our network of Tech Hubs and the communities they serve.">
  <Header />
  <main>
    <!-- Hero Section -->
    <section class="py-20 bg-gradient-to-br from-primary-50 to-secondary-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-4xl lg:text-6xl font-bold text-gray-900 mb-6">
          Community <span class="text-primary-600">Insights</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Real stories from real communities. See how local tech support is making a difference 
          in nonprofits, small businesses, and neighborhoods across the country.
        </p>
      </div>
    </section>

    <!-- API Integration Notice -->
    <section class="py-8 bg-blue-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-blue-100 border border-blue-200 rounded-lg p-6">
          <div class="flex items-start">
            <svg class="w-6 h-6 text-blue-600 mt-0.5 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h3 class="text-lg font-medium text-blue-800 mb-2">Dynamic Content Integration</h3>
              <p class="text-blue-700 mb-3">
                This page will automatically pull blog posts and insights from your WordPress backend at 
                <strong>hub.maxsys.org</strong> using the WordPress REST API. The integration will display:
              </p>
              <ul class="text-blue-700 space-y-1 text-sm">
                <li>• Latest blog posts with featured images, excerpts, and publication dates</li>
                <li>• Category filtering (Success Stories, Case Studies, Community Impact, etc.)</li>
                <li>• Search functionality across all content</li>
                <li>• Pagination for easy browsing</li>
                <li>• Author information and social sharing</li>
              </ul>
              <p class="text-blue-700 mt-3 text-sm">
                <strong>API Endpoint:</strong> https://hub.maxsys.org/wp-json/wp/v2/posts
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Featured Story -->
    <section class="py-20 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-gradient-to-r from-primary-600 to-secondary-600 rounded-3xl overflow-hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2">
            <div class="p-12 text-white">
              <div class="bg-white/20 text-white px-3 py-1 rounded-full text-sm font-semibold mb-4 inline-block">
                Featured Story
              </div>
              <h2 class="text-3xl font-bold mb-6">
                How Charlotte's Animal Shelter Doubled Adoptions with Local Tech Support
              </h2>
              <p class="text-primary-100 mb-6">
                When the Charlotte Animal Shelter's website crashed during their biggest adoption event of the year, 
                local Tech Steward Marcus Johnson didn't just fix the problem—he rebuilt their entire digital presence 
                and helped them reach more families than ever before.
              </p>
              <div class="flex items-center space-x-4 mb-6">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                  <span class="text-white font-semibold">MJ</span>
                </div>
                <div>
                  <div class="font-semibold">Marcus Johnson</div>
                  <div class="text-primary-200 text-sm">Tech Steward, Charlotte NC</div>
                </div>
              </div>
              <a 
                href="#" 
                class="bg-white text-primary-600 px-6 py-3 rounded-lg font-semibold hover:bg-primary-50 transition-colors duration-200 inline-block"
              >
                Read Full Story
              </a>
            </div>
            <div class="relative">
              <img 
                src="https://images.pexels.com/photos/6131071/pexels-photo-6131071.jpeg?auto=compress&cs=tinysrgb&w=1200&h=800&fit=crop"
                alt="Animal shelter success story"
                class="w-full h-full object-cover"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Categories -->
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Browse by Category</h2>
          <div class="flex flex-wrap justify-center gap-4">
            <button class="category-filter active bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition-colors duration-200" data-category="all">
              All Stories
            </button>
            <button class="category-filter bg-white text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors duration-200" data-category="success-stories">
              Success Stories
            </button>
            <button class="category-filter bg-white text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors duration-200" data-category="case-studies">
              Case Studies
            </button>
            <button class="category-filter bg-white text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors duration-200" data-category="community-impact">
              Community Impact
            </button>
            <button class="category-filter bg-white text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors duration-200" data-category="tech-steward-spotlight">
              Tech Steward Spotlight
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Blog Posts Grid (Will be populated via API) -->
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="blog-posts-container">
          <!-- Loading state -->
          <div id="loading-state" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <p class="mt-4 text-gray-600">Loading insights from hub.maxsys.org...</p>
          </div>
          
          <!-- Blog posts will be inserted here via JavaScript -->
          <div id="blog-posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 hidden">
            <!-- Posts will be dynamically loaded here -->
          </div>
          
          <!-- Error state -->
          <div id="error-state" class="text-center py-12 hidden">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Unable to Load Content</h3>
            <p class="text-gray-600 mb-4">We're having trouble connecting to our content source. Please try again later.</p>
            <button onclick="loadBlogPosts()" class="bg-primary-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-primary-700 transition-colors duration-200">
              Retry
            </button>
          </div>
        </div>

        <!-- Load More -->
        <div id="load-more-container" class="text-center mt-12 hidden">
          <button id="load-more-btn" class="bg-primary-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-700 transition-colors duration-200">
            Load More Stories
          </button>
        </div>
      </div>
    </section>

    <!-- Newsletter Signup -->
    <section class="py-20 bg-gradient-to-r from-primary-600 to-secondary-600 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl lg:text-4xl font-bold mb-6">Stay Updated</h2>
        <p class="text-xl text-primary-100 max-w-2xl mx-auto mb-8">
          Get the latest community stories, case studies, and updates from our network of Tech Hubs delivered to your inbox.
        </p>
        
        <div class="max-w-md mx-auto">
          <div class="flex space-x-4">
            <input 
              type="email" 
              placeholder="Enter your email address"
              class="flex-1 px-4 py-3 rounded-lg text-gray-900 focus:ring-2 focus:ring-white focus:outline-none"
            />
            <button class="bg-white text-primary-600 px-6 py-3 rounded-lg font-semibold hover:bg-primary-50 transition-colors duration-200">
              Subscribe
            </button>
          </div>
          <p class="text-primary-200 text-sm mt-3">
            No spam, unsubscribe anytime. We respect your privacy.
          </p>
        </div>
      </div>
    </section>
  </main>
  <Footer />
  <DonationBanner />
</Layout>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadBlogPosts();
  setupCategoryFilters();
});

let currentPage = 1;
let allPosts = [];
let filteredPosts = [];
let currentCategory = 'all';

async function loadBlogPosts() {
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const blogGrid = document.getElementById('blog-posts-grid');
  
  try {
    loadingState.classList.remove('hidden');
    errorState.classList.add('hidden');
    blogGrid.classList.add('hidden');
    
    // WordPress REST API endpoint
    const response = await fetch('https://hub.maxsys.org/wp-json/wp/v2/posts?per_page=20&_embed');
    
    if (!response.ok) {
      throw new Error('Failed to fetch posts');
    }
    
    const posts = await response.json();
    allPosts = posts;
    filteredPosts = posts;
    
    displayPosts(posts);
    
    loadingState.classList.add('hidden');
    blogGrid.classList.remove('hidden');
    document.getElementById('load-more-container').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error loading blog posts:', error);
    loadingState.classList.add('hidden');
    errorState.classList.remove('hidden');
  }
}

function displayPosts(posts) {
  const blogGrid = document.getElementById('blog-posts-grid');
  blogGrid.innerHTML = '';
  
  posts.forEach(post => {
    const postElement = createPostElement(post);
    blogGrid.appendChild(postElement);
  });
}

function createPostElement(post) {
  const article = document.createElement('article');
  article.className = 'blog-post bg-white border border-gray-200 rounded-2xl overflow-hidden hover:shadow-lg transition-shadow duration-200';
  
  // Get featured image
  const featuredImage = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || 
                       'https://images.pexels.com/photos/3184465/pexels-photo-3184465.jpeg?auto=compress&cs=tinysrgb&w=600&h=400&fit=crop';
  
  // Get category
  const category = post._embedded?.['wp:term']?.[0]?.[0]?.name || 'Insights';
  
  // Get author
  const author = post._embedded?.author?.[0]?.name || 'Maxsys Team';
  
  // Format date
  const date = new Date(post.date).toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
  
  // Create excerpt
  const excerpt = post.excerpt.rendered.replace(/<[^>]*>/g, '').substring(0, 150) + '...';
  
  article.innerHTML = `
    <img 
      src="${featuredImage}"
      alt="${post.title.rendered}"
      class="w-full h-48 object-cover"
    />
    <div class="p-6">
      <div class="flex items-center justify-between mb-3">
        <span class="bg-primary-100 text-primary-800 px-3 py-1 rounded-full text-xs font-semibold">${category}</span>
        <span class="text-gray-500 text-sm">${date}</span>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-3">
        ${post.title.rendered}
      </h3>
      <p class="text-gray-600 text-sm mb-4">
        ${excerpt}
      </p>
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
            <span class="text-white text-xs font-semibold">${author.charAt(0)}</span>
          </div>
          <span class="text-gray-600 text-sm">${author}</span>
        </div>
        <a href="${post.link}" target="_blank" class="text-primary-600 font-semibold text-sm hover:text-primary-700">Read More →</a>
      </div>
    </div>
  `;
  
  return article;
}

function setupCategoryFilters() {
  const categoryButtons = document.querySelectorAll('.category-filter');
  
  categoryButtons.forEach(button => {
    button.addEventListener('click', function() {
      const category = this.getAttribute('data-category');
      currentCategory = category;
      
      // Update active button
      categoryButtons.forEach(btn => {
        btn.classList.remove('active', 'bg-primary-600', 'text-white');
        btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
      });
      
      this.classList.add('active', 'bg-primary-600', 'text-white');
      this.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
      
      // Filter posts
      if (category === 'all') {
        filteredPosts = allPosts;
      } else {
        filteredPosts = allPosts.filter(post => {
          const postCategories = post._embedded?.['wp:term']?.[0] || [];
          return postCategories.some(cat => cat.slug.includes(category.replace('-', '')));
        });
      }
      
      displayPosts(filteredPosts);
    });
  });
}

// Load more functionality
document.getElementById('load-more-btn')?.addEventListener('click', function() {
  currentPage++;
  // In a real implementation, this would load more posts from the API
  console.log('Loading more posts...');
});
</script>